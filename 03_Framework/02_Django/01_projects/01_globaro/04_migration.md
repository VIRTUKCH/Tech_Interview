# Migration

## 1. 마이그레이션이란?
마이그레이션은 데이터베이스 스키마의 변경 사항을 관리하는 과정이다. 예를 들어, 새로운 테이블을 추가하거나 기존 테이블의 컬럼을 수정하거나 삭제할 때, 이 변경 사항을 마이그레이션으로 관리한다.

Django 에서는 Python 클래스로 데이터베이스 모델을 정의한 후, makemigrations 명령어로 변경 사항을 마이그레이션 파일로 생성하고, migrate 명령어로 이를 데이터베이스에 반영한다.

## 2. Django 와 PostgreSQL 이 테이블을 관리하는 방법
Django 는 ORM(Object-Relation Mapping) 을 통해서 Python 코드로 데이터베이스를 관리한다. PostgreSQL 과 같은 데이터베이스를 사용할 때도 SQL 을 직접 작성하지 않아도 된다.

### 2-1. models.py 파일에 모델 정의
나는 테이블 단위로 어플리케이션을 만들었다. 해당 클래스 내에서 각 필드는 테이블의 컬럼에 해당하며, 다른 ORM 과 마찬가지로 데이터 타입과 제약 조건도 정의할 수 있다.

### 2-2. 마이그레이션 생성
```bash
python manage.py makemigrations
```
해당 명령어를 실행하면 models.py 파일에 있는 변경 사항을 감지하여 새로운 마이그레이션 파일이 생성된다. 만약 변경 사항이 있다면 변경 사항에 대해서만 새로운 마이그레이션을 만들어 낸다.

### 2-3. 마이그레이션 적용
```bash
python manage.py migrate
```
해당 명령어를 실행하면 마이그레이션 파일에 기록된 변경 사항이 SQL 로 변환되어 PostgreSQL 에 적용된다. 만약에 다른 프로젝트가 가지고 있는 테이블을 그대로 가져오고 싶고, 이미 마이그레이션 파일이 있다면 새로운 마이그레이션 파일을 만들 필요 없이 적용만 하면 되겠다. (데이터는 같이 안 넘어온다.)

Django 는 데이터베이스 변경 이력을 추적하기 위해 django_migrations 라는 테이블을 사용한다. 이를 통해 어떤 마이그레이션이 적용되었는지 확인할 수도 있다.

## 3. Django 에서 마이그레이션 디렉터리에 있는 정보
Django 프로젝트의 각 앱에는 migrations 라는 디렉터리가 포함되어 있다. 이 디렉터리는 데이터베이스 변경 사항을 기록한 마이그레이션 파일들을 저장하는 곳이다.

### 3-1. 초기 마이그레이션 파일
앱 생성 시 0001_initial.py 파일이 생성된다. 이 파일은 테이블의 초기 구조를 정의한다.

### 3-2. 후속 마이그레이션 파일
모델에 변경 사항이 생길 때마다 새로운 마이그레이션 파일이 추가로 생성된다. 물론 python manage.py makemigrations 명령어를 통해 마이그레이션 파일을 만들어야 한다.

### 3-3. 파일 구조
마이그레이션 파일에는 dependencies 와 operations 정보가 포함되어 있다.

- dependencies : 현재 마이그레이션 파일이 의존하는 이전 마이그레이션을 나타낸다.
- operations : 데이터베이스에서 실행할 작업(테이블 생성, 컬럼 추가 및 수정 등) 이 정의된다.

## 4. 내가 겪은 오류 이야기

### 4-1. /migrations 디렉터리에 있는 정보와 실제 데이터베이스 내용의 불일치
```bash
python manage.py showmigrates
```
해당 명령어를 사용하면 마이그레이션이 어디까지 적용되었는지 볼 수 있다. 명령어를 통해 조회한 결과 테이블이 데이터베이스에 만들어져야 하지만, 실제 데이터베이스 서버에는 해당 테이블이 만들어지지 않았다.

### 4-2. 마이그레이션을 적용하지 않아서 그런 줄 알았다.
```bash
python manage.py migrate
```
해당 명령어를 통해 마이그레이션을 적용했으나, '이미 다 적용되었다' 는 메시지를 얻을 뿐, 정작 데이터베이스 서버에는 테이블이 만들어지지 않았다.

### 4-3. 원인은 --fake 옵션에
```bash
python manage.py migrate --fake
```
해당 명령어는 이미 데이터베이스에 테이블이 존재하지만 Django 는 모르는 경우, 해당 상태만 업데이트하는 명령어이다.

보통은 Django 가 가지고 있는 테이블에 대한 정보를 -> DB 서버가 수용하는 방식이지만, 이 명령어 만큼은 DB 에 있는 것을 토대로 Django 가 인식하는 것이다.

마이그레이션 파일, models.py 같은 파일에 대한 변화가 전혀 이루어지지 않기 때문에 패러다임이 다름에서 오는 문제를 추후 방지하지 못하는 데에 치명적인 문제가 있는 명령어로 보인다.

### 4-4. 그래서 내가 한 조치는 데이터베이스에서 기존 마이그레이션 기록 초기화
```sql
-- 1. 데이터베이스에서 Django 의 마이그레이션 기록 삭제
DELETE FROM django_migrations;

-- 2. Django 와 관련된 테이블 모두 삭제
DROP SCHEMA public CASCADE;
CREATE SCHEMA public;
```

일단 데이터베이스 서버에 들어가서 장고와 관련된 테이블을 모두 삭제했다. 그 다음에는 Django 에서 데이터베이스 마이그레이션과 관련된 파일을 모두 삭제했다.

온전히 models.py 파일에만 의존하여 테이블을 생성할 수 있도록 기존의 데이터를 모두 날렸다.

```bash
# 1. 모든 어플리케이션 패키지에 들어가서 마이그레이션 파일 날리기
rm -r {application_name}/migrations/*.py {application_name}/migrations/*.py
touch {application_name}/migrations/__init__.py
touch {application_name}/migrations/__init__.py

# 2. 새로운 마이그레이션 파일 생성
python manage.py makemigrations

# 3. 모든 마이그레이션 적용
python manage.py migrate
```

일단 여기까지 해서 문제는 해결했다. 데이터베이스 서버에 데이터가 적절하게 들어가는 모습을 볼 수 있었다.

# 근데도 문제가 있다면 아래 절차를 따라해 보자.

### 4-5. 데이터베이스와 마이그레이션 상태 강제 일치
#### **(1) `--fake`로 상태만 업데이트**
이미 데이터베이스에 테이블이 존재하지만 Django는 이를 모르는 경우:
```bash
python manage.py migrate --fake
```

#### **(2) `--fake-initial`로 초기 상태 강제 처리**
초기 마이그레이션 파일과 데이터베이스가 불일치할 경우, `--fake-initial`로 상태를 강제로 동기화한다.
```bash
python manage.py migrate --fake-initial
```

---

### 4-6. **새로운 마이그레이션 파일을 적용한 후 테스트**

새롭게 생성된 테이블이 올바르게 생성되었는지 확인해 보자.
```bash
\dt
```
테이블이 정상적으로 생성되었다면, 데이터베이스와 Django 상태가 일치한 것이다.